<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QZ Mock Test (Maths – 20 Questions, 20 Minutes)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--blue:#0b5ed7;--card:#ffffff;--text:#12263a;--green:#198754;--red:#dc3545;--grey:#6c757d;}
  body{font-family:"Noto Sans Devanagari",Arial,sans-serif;background:linear-gradient(180deg,#eef6ff,#ffffff);margin:0;color:var(--text);}
  .header{background:var(--blue);color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
  .title{font-weight:700;font-size:18px;}
  .timer{background:rgba(255,255,255,0.12);padding:8px 10px;border-radius:6px;font-weight:700;}
  .container{max-width:1180px;margin:18px auto;display:flex;gap:18px;padding:0 12px;align-items:flex-start;}
  .main{flex:1;background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 20px rgba(11,78,215,0.06);}
  .sidebar{width:260px;background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.03);}
  .questionCanvas{width:100%;height:auto;margin-bottom:14px;border-radius:8px;border:1px solid #e6f0ff;overflow:hidden;background:#fff;}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center;}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
  .btn.primary{background:var(--blue);color:white;}
  .btn.warn{background:#ff6b6b;color:white;}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px;}
  .qbox{background:#f1f5f9;padding:10px;text-align:center;border-radius:6px;font-weight:700;cursor:pointer;user-select:none;}
  .qbox.review{background:#e8daff;}
  .qbox.attempted{background:#cfe5ff;}
  .result{display:none;padding:12px;}
  .qlist{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px;}
  .qitem{padding:8px;border-radius:6px;text-align:center;font-weight:700;color:white;}
  .legend{display:flex;gap:8px;align-items:center;margin-top:8px;}
  .small{font-size:13px;color:#6c757d;}
  @media(max-width:900px){.container{flex-direction:column}.sidebar{width:100%}.qlist,.grid{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>

<div class="header">
  <div class="title">QZ Mock Test (Maths – 20 Questions, 20 Minutes)</div>
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="small">उम्मीदवार: <strong>नाम दर्ज करें</strong></div>
    <div class="timer" id="timer">20:00</div>
  </div>
</div>

<div class="container">
  <div class="main">
    <div id="testArea">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small">प्रश्न: सभी 20 नीचे दिख रहे हैं</div>
        <div class="small">समय शेष: <strong id="timer2">20:00</strong></div>
      </div>

      <div id="canvasWrap" style="margin-top:12px;">
        <!-- Canvases will be injected here -->
      </div>

      <div class="controls">
        <button class="btn primary" id="saveAll">सहेजें (Auto-save होता है)</button>
        <button class="btn" id="clearAll">सभी उत्तर हटाएं</button>
        <button class="btn" id="markAllReview">टॉगल मार्क फॉर रिव्यू</button>
        <button class="btn warn" id="submitBtn" style="margin-left:auto">सबमिट टेस्ट</button>
      </div>
    </div>

    <div class="result" id="resultArea">
      <h3>रिज़ल्ट</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
        <div style="padding:8px 12px;border-radius:8px;background:rgba(25,135,84,0.12);color:var(--green);font-weight:700" id="resCorrect">सही: 0</div>
        <div style="padding:8px 12px;border-radius:8px;background:rgba(220,53,69,0.08);color:var(--red);font-weight:700" id="resWrong">गलत: 0</div>
        <div style="padding:8px 12px;border-radius:8px;background:rgba(108,117,125,0.08);color:var(--grey);font-weight:700" id="resAttempt">प्रयास: 0</div>
      </div>

      <div class="small">कुल प्रश्न: 20</div>
      <div style="margin-top:8px;">
        <div>कुल अंक: <strong id="totalMarks">0</strong> / 20</div>
        <div>प्रतिशत: <strong id="percentage">0%</strong></div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">प्रश्नों की स्थिति</div>
        <div class="qlist" id="qResultList"></div>
        <div class="legend">
          <span><i style="display:inline-block;width:14px;height:14px;background:var(--green);margin-right:6px"></i> सही</span>
          <span><i style="display:inline-block;width:14px;height:14px;background:var(--red);margin-right:6px"></i> गलत</span>
          <span><i style="display:inline-block;width:14px;height:14px;background:var(--grey);margin-right:6px"></i> नहीं किया</span>
        </div>
      </div>
    </div>

  </div>

  <div class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div><strong>प्रश्न सूची</strong></div>
      <div class="small">20 प्रश्न</div>
    </div>
    <div class="grid" id="qGrid"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
      <div class="small">नोट: 1 अंक / गलत -0.25</div>
      <div><button class="btn" id="fullscreenBtn">फुल-स्क्रीन</button></div>
    </div>
  </div>
</div>

<!-- load questions -->
<script src="questions.js"></script>

<script>
/* ========= Anti-cheat: disable selection / right-click / inspect ========= */
(function(){
  document.addEventListener('contextmenu', e=>e.preventDefault());
  document.addEventListener('selectstart', e=>e.preventDefault());
  document.addEventListener('copy', e=>e.preventDefault());
  document.addEventListener('cut', e=>e.preventDefault());
  window.addEventListener('keydown', function(e){
    if(e.keyCode===123 || (e.ctrlKey && e.shiftKey && (e.key==='I' || e.key==='J')) || (e.ctrlKey && e.key==='u')) { e.preventDefault(); e.stopPropagation(); }
  });
})();

/* ========= Quiz core (Canvas rendering for all 20 questions) ========= */
const TOTAL = 20;
let userAnswers = Array(TOTAL).fill(null); // store actual option index relative to QUESTIONS[i].options
let reviewFlags = Array(TOTAL).fill(false);
let optionOrder = [];
let timerSeconds = 20 * 60;
let timerInterval = null;

/* Helper: text wrap */
function wrapText(context, text, x, y, maxWidth, lineHeight){
  const words = text.split(' ');
  let line = '';
  for(let n=0;n<words.length;n++){
    const testLine = line + words[n] + ' ';
    const metrics = context.measureText(testLine);
    const testWidth = metrics.width;
    if(testWidth > maxWidth && n > 0){
      context.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  context.fillText(line, x, y);
}

/* Create canvases for all questions */
const canvasWrap = document.getElementById('canvasWrap');
function createAllCanvases(){
  canvasWrap.innerHTML = '';
  for(let i=0;i<TOTAL;i++){
    const cWrap = document.createElement('div');
    cWrap.style.marginBottom = '12px';
    const canvas = document.createElement('canvas');
    canvas.className = 'questionCanvas';
    canvas.id = 'qCanvas' + i;
    // set internal resolution for crisp text
    canvas.width = 1000;
    canvas.height = 200; // adequate height; grows with text wrapping if needed later
    cWrap.appendChild(canvas);
    canvasWrap.appendChild(cWrap);
  }
}

/* Draw a specific question on its canvas */
function drawQuestionCanvas(idx){
  const canvas = document.getElementById('qCanvas' + idx);
  const ctx = canvas.getContext('2d');
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // header bar
  ctx.fillStyle = "#0b5ed7";
  ctx.fillRect(0,0,canvas.width,52);
  ctx.fillStyle = "#fff";
  ctx.font = "700 18px 'Noto Sans Devanagari', sans-serif";
  ctx.fillText("Q" + (idx+1), 18, 34);

  // question text
  ctx.fillStyle = "#12263a";
  ctx.font = "700 16px 'Noto Sans Devanagari', sans-serif";
  const qText = (idx+1) + ". " + QUESTIONS[idx].question;
  wrapText(ctx, qText, 18, 74, canvas.width - 36, 20);

  // options
  const startY = 110;
  const boxH = 30;
  const ord = optionOrder[idx];
  // ensure enough height — if question long, increase canvas height (simple approach)
  // (not changing canvas.height now to keep simple; text wraps inside area)
  for(let i=0;i<4;i++){
    const optIdx = ord[i];
    const x = 18;
    const y = startY + i*(boxH + 10);
    const w = canvas.width - 36;
    const h = boxH;
    // highlight if selected
    if(userAnswers[idx] === optIdx){
      ctx.fillStyle = "#d9ecff";
      ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = "#8fc3ff";
      ctx.strokeRect(x,y,w,h);
    } else {
      ctx.fillStyle = "#f8fbff";
      ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = "#e6f0ff";
      ctx.strokeRect(x,y,w,h);
    }
    ctx.fillStyle = "#12263a";
    ctx.font = "700 14px 'Noto Sans Devanagari', sans-serif";
    const label = String.fromCharCode(65 + i) + ". ";
    // draw option text wrapped within the box
    wrapText(ctx, label + QUESTIONS[idx].options[optIdx], x + 8, y + 20, w - 16, 16);
  }

  // draw review marker if flagged
  if(reviewFlags[idx]){
    ctx.fillStyle = "#6f42c1"; // purple
    ctx.font = "700 12px 'Noto Sans Devanagari', sans-serif";
    ctx.fillText("Marked for review", canvas.width - 170, 34);
  }
}

/* Click handling: detect which option box clicked for each canvas */
function setupCanvasClicks(){
  for(let i=0;i<TOTAL;i++){
    const canvas = document.getElementById('qCanvas' + i);
    canvas.addEventListener('click', function(e){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const cx = (e.clientX - rect.left) * scaleX;
      const cy = (e.clientY - rect.top) * scaleY;
      // options start at y=110, boxH=30, gap=10
      const startY = 110;
      const boxH = 30;
      for(let k=0;k<4;k++){
        const y = startY + k*(boxH + 10);
        if(cx >= 18 && cx <= canvas.width - 18 && cy >= y && cy <= y + boxH){
          // option k clicked for question i
          const optIdx = optionOrder[i][k];
          userAnswers[i] = optIdx;
          // redraw this canvas
          drawQuestionCanvas(i);
          markAttempted(i);
          return;
        }
      }
    });
  }
}

/* Grid sidebar */
function initGrid(){
  const grid = document.getElementById('qGrid');
  grid.innerHTML = '';
  for(let i=0;i<TOTAL;i++){
    const d = document.createElement('div');
    d.className = 'qbox';
    d.id = 'box'+i;
    d.innerText = 'Q' + (i+1);
    d.addEventListener('click', ()=> { scrollToCanvas(i); });
    grid.appendChild(d);
  }
}
function updateGridStyles(){
  for(let i=0;i<TOTAL;i++){
    const b = document.getElementById('box'+i);
    b.classList.remove('attempted','review');
    b.style.background=''; b.style.color='';
    if(userAnswers[i] !== null) b.classList.add('attempted');
    if(reviewFlags[i]) b.classList.add('review');
  }
}
function markAttempted(idx){
  const box = document.getElementById('box'+idx);
  if(userAnswers[idx] !== null) { box.classList.add('attempted'); }
}

/* Option shuffle for each question */
function shuffleOptionsForAll(){
  optionOrder = QUESTIONS.map(q=>{
    const arr = [0,1,2,3];
    for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  });
}

/* Buttons */
document.getElementById('saveAll').addEventListener('click', ()=>{
  // nothing required — selections are already in userAnswers
  alert('सभी उत्तर सहेज दिए गए हैं (Auto-save)।');
});
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(!confirm('क्या आप वाकई सभी उत्तर हटाना चाहते हैं?')) return;
  userAnswers = Array(TOTAL).fill(null);
  reviewFlags = Array(TOTAL).fill(false);
  for(let i=0;i<TOTAL;i++) drawQuestionCanvas(i);
  updateGridStyles();
});
document.getElementById('markAllReview').addEventListener('click', ()=>{
  // toggle review flag for currently visible? We'll toggle all for demo (user can use sidebar later)
  const anyFalse = reviewFlags.some(f=>!f);
  for(let i=0;i<TOTAL;i++) reviewFlags[i] = anyFalse;
  for(let i=0;i<TOTAL;i++) drawQuestionCanvas(i);
  updateGridStyles();
});
document.getElementById('submitBtn').addEventListener('click', ()=>{
  if(confirm('क्या आप टेस्ट सबमिट करना चाहते हैं?')) doSubmit();
});
document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
});

/* Timer */
function startTimer(){
  updateTimerDisplay();
  timerInterval = setInterval(()=>{
    timerSeconds--;
    updateTimerDisplay();
    if(timerSeconds <= 0){ clearInterval(timerInterval); alert('समय समाप्त! टेस्ट स्वतः सबमिट हो रहा है।'); doSubmit(); }
  },1000);
}
function updateTimerDisplay(){
  const mm = String(Math.floor(timerSeconds/60)).padStart(2,'0');
  const ss = String(timerSeconds%60).padStart(2,'0');
  document.getElementById('timer').innerText = mm+':'+ss;
  document.getElementById('timer2').innerText = mm+':'+ss;
}

/* Submit & Result */
function doSubmit(){
  if(timerInterval) clearInterval(timerInterval);
  calculateResult();
}
function calculateResult(){
  let correct=0, wrong=0, attempted=0, marks=0;
  for(let i=0;i<TOTAL;i++){
    const sel = userAnswers[i];
    if(sel === null) continue;
    attempted++;
    const actualCorrect = QUESTIONS[i].correct;
    if(sel === actualCorrect){ correct++; marks += 1; }
    else { wrong++; marks -= 0.25; }
  }
  marks = Math.round(marks*100)/100;
  const percent = Math.round((marks / TOTAL) * 10000)/100;
  showResult({attempted, correct, wrong, marks, percent});
}
function showResult({attempted, correct, wrong, marks, percent}){
  document.getElementById('testArea').style.display='none';
  const ra = document.getElementById('resultArea'); ra.style.display='block';
  document.getElementById('resCorrect').innerText = 'सही: ' + correct;
  document.getElementById('resWrong').innerText = 'गलत: ' + wrong;
  document.getElementById('resAttempt').innerText = 'प्रयास: ' + attempted;
  document.getElementById('totalMarks').innerText = marks;
  document.getElementById('percentage').innerText = percent + '%';

  const qRes = document.getElementById('qResultList'); qRes.innerHTML = '';
  for(let i=0;i<TOTAL;i++){
    const div = document.createElement('div'); div.className='qitem';
    if(userAnswers[i] === null){ div.style.background='var(--grey)'; div.innerText='Q'+(i+1); }
    else if(userAnswers[i] === QUESTIONS[i].correct){ div.style.background='var(--green)'; div.innerText='Q'+(i+1); }
    else { div.style.background='var(--red)'; div.innerText='Q'+(i+1); }
    qRes.appendChild(div);
    // sidebar box final colors
    const box = document.getElementById('box'+i);
    if(userAnswers[i] === null){ box.style.background='var(--grey)'; box.style.color='white'; }
    else if(userAnswers[i] === QUESTIONS[i].correct){ box.style.background='var(--green)'; box.style.color='white'; }
    else { box.style.background='var(--red)'; box.style.color='white'; }
  }
  window.scrollTo({top:0,behavior:'smooth'});
}

/* Scroll to canvas */
function scrollToCanvas(i){
  const el = document.getElementById('qCanvas' + i);
  if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

/* Initialize everything */
function initializeTest(){
  if(typeof QUESTIONS === 'undefined' || QUESTIONS.length < TOTAL){ alert('प्रश्न उपलब्ध नहीं हैं (questions.js)।'); return; }
  // prepare canvases
  createAllCanvases();
  // shuffle options
  shuffleOptionsForAll();
  // draw all
  for(let i=0;i<TOTAL;i++) drawQuestionCanvas(i);
  // setup clicks
  setupCanvasClicks();
  // sidebar
  initGrid();
  updateGridStyles();
  // start timer
  startTimer();
}

/* Start on load */
window.addEventListener('load', initializeTest);
</script>

</body>
</html>
